<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Extractor API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="url"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input[type="url"]:focus, select:focus {
            border-color: #4CAF50;
            outline: none;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-extract {
            background-color: #2196F3;
            color: white;
        }
        .btn-extract:hover {
            background-color: #1976D2;
        }
        .btn-download {
            background-color: #4CAF50;
            color: white;
        }
        .btn-download:hover {
            background-color: #45a049;
        }
        .btn-download:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .results {
            margin-top: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .error {
            border-left-color: #f44336;
            background-color: #ffebee;
        }
        .source-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .source-url {
            word-break: break-all;
            color: #666;
            font-size: 14px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s ease;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
        }
        .download-link {
            display: inline-block;
            margin-top: 10px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
        .download-link:hover {
            background-color: #45a049;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• Video Extractor API</h1>
        
        <div class="form-group">
            <label for="videoUrl">Video URL:</label>
            <input type="url" id="videoUrl" placeholder="https://example.com/video" required>
        </div>
        
        <div class="form-group">
            <label for="quality">Quality Preference:</label>
            <select id="quality">
                <option value="best">Best Quality</option>
                <option value="1080">1080p</option>
                <option value="720">720p</option>
                <option value="480">480p</option>
                <option value="360">360p</option>
                <option value="worst">Worst Quality</option>
            </select>
        </div>
        
        <div class="button-group">
            <button class="btn-extract" onclick="extractSources()">
                <span id="extractText">üîç Extract Sources</span>
                <span id="extractLoading" class="loading" style="display: none;"></span>
            </button>
            <button class="btn-download" id="downloadBtn" onclick="startDownload()" disabled>
                <span id="downloadText">‚¨áÔ∏è Download Video</span>
                <span id="downloadLoading" class="loading" style="display: none;"></span>
            </button>
        </div>
        
        <div id="results"></div>
        <div id="downloadStatus"></div>
    </div>

    <script>
        let currentSources = [];
        let downloadId = null;
        let statusInterval = null;

        async function extractSources() {
            const url = document.getElementById('videoUrl').value;
            if (!url) {
                alert('Please enter a video URL');
                return;
            }

            const extractBtn = document.querySelector('.btn-extract');
            const extractText = document.getElementById('extractText');
            const extractLoading = document.getElementById('extractLoading');
            
            extractBtn.disabled = true;
            extractText.style.display = 'none';
            extractLoading.style.display = 'inline-block';

            try {
                const response = await fetch('/extract', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentSources = data.sources;
                    displaySources(data);
                    document.getElementById('downloadBtn').disabled = false;
                } else {
                    displayError(data.error || 'Failed to extract sources');
                }
            } catch (error) {
                displayError('Network error: ' + error.message);
            } finally {
                extractBtn.disabled = false;
                extractText.style.display = 'inline';
                extractLoading.style.display = 'none';
            }
        }

        async function startDownload() {
            const url = document.getElementById('videoUrl').value;
            const quality = document.getElementById('quality').value;

            const downloadBtn = document.getElementById('downloadBtn');
            const downloadText = document.getElementById('downloadText');
            const downloadLoading = document.getElementById('downloadLoading');
            
            downloadBtn.disabled = true;
            downloadText.style.display = 'none';
            downloadLoading.style.display = 'inline-block';

            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url, quality: quality })
                });

                const data = await response.json();
                
                if (data.success) {
                    downloadId = data.download_id;
                    displayDownloadStarted(data);
                    startStatusPolling();
                } else {
                    displayError(data.error || 'Failed to start download');
                    downloadBtn.disabled = false;
                    downloadText.style.display = 'inline';
                    downloadLoading.style.display = 'none';
                }
            } catch (error) {
                displayError('Network error: ' + error.message);
                downloadBtn.disabled = false;
                downloadText.style.display = 'inline';
                downloadLoading.style.display = 'none';
            }
        }

        function startStatusPolling() {
            if (statusInterval) clearInterval(statusInterval);
            
            let pollCount = 0;
            const maxPolls = 150; // 5 minutes max (150 * 2 seconds)
            
            statusInterval = setInterval(async () => {
                if (!downloadId) return;
                
                pollCount++;
                
                try {
                    const response = await fetch(`/status/${downloadId}`);
                    
                    if (response.status === 404) {
                        // Download ID not found - might have completed very quickly
                        console.log('Download ID not found - checking if download completed quickly');
                        clearInterval(statusInterval);
                        statusInterval = null;
                        
                        // Try to check if file is available for download
                        try {
                            const downloadResponse = await fetch(`/download/${downloadId}`, {method: 'HEAD'});
                            if (downloadResponse.ok) {
                                // File exists, show download link
                                updateDownloadStatus({
                                    status: 'completed',
                                    progress: 100,
                                    message: 'Download completed successfully!',
                                    file_ready: true
                                });
                            } else {
                                // File doesn't exist, show error
                                updateDownloadStatus({
                                    status: 'failed',
                                    progress: 0,
                                    message: 'Download status not found. Download may have failed or completed too quickly.'
                                });
                            }
                        } catch (downloadError) {
                            updateDownloadStatus({
                                status: 'failed',
                                progress: 0,
                                message: 'Unable to verify download status.'
                            });
                        }
                        
                        resetDownloadButton();
                        return;
                    }
                    
                    const status = await response.json();
                    updateDownloadStatus(status);
                    
                    if (status.status === 'completed' || status.status === 'failed' || status.status === 'cancelled') {
                        clearInterval(statusInterval);
                        statusInterval = null;
                        resetDownloadButton();
                    }
                    
                    // Stop polling after max attempts
                    if (pollCount >= maxPolls) {
                        clearInterval(statusInterval);
                        statusInterval = null;
                        updateDownloadStatus({
                            status: 'timeout',
                            progress: 0,
                            message: 'Status polling timed out. Download may still be in progress.'
                        });
                        resetDownloadButton();
                    }
                    
                } catch (error) {
                    console.error('Status polling error:', error);
                    pollCount++;
                    
                    if (pollCount >= 5) { // Stop after 5 consecutive errors
                        clearInterval(statusInterval);
                        statusInterval = null;
                        updateDownloadStatus({
                            status: 'error',
                            progress: 0,
                            message: 'Unable to check download status due to network errors.'
                        });
                        resetDownloadButton();
                    }
                }
            }, 2000);
        }
        
        function resetDownloadButton() {
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadText = document.getElementById('downloadText');
            const downloadLoading = document.getElementById('downloadLoading');
            
            downloadBtn.disabled = false;
            downloadText.style.display = 'inline';
            downloadLoading.style.display = 'none';
        }

        function displaySources(data) {
            const resultsDiv = document.getElementById('results');
            let html = `
                <h3>‚úÖ Found ${data.sources_found} video source(s):</h3>
            `;
            
            data.sources.forEach((source, index) => {
                html += `
                    <div class="source-item">
                        <strong>Source ${index + 1}:</strong><br>
                        üì∫ Quality: ${source.quality > 0 ? source.quality + 'p' : 'Unknown'}<br>
                        üìÑ Format: ${source.format}<br>
                        üîß Method: ${source.method}<br>
                        üìù Title: ${source.title}<br>
                        ${source.filesize ? `üìä Size: ${(source.filesize / (1024*1024)).toFixed(2)} MB<br>` : ''}
                        ${source.duration ? `‚è±Ô∏è Duration: ${Math.floor(source.duration / 60)}:${(source.duration % 60).toString().padStart(2, '0')}<br>` : ''}
                        <div class="source-url">üîó ${source.url.substring(0, 100)}${source.url.length > 100 ? '...' : ''}</div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
            resultsDiv.className = 'results';
        }

        function displayDownloadStarted(data) {
            const statusDiv = document.getElementById('downloadStatus');
            statusDiv.innerHTML = `
                <div class="status">
                    <h3>üöÄ Download Started</h3>
                    <p><strong>Download ID:</strong> ${data.download_id}</p>
                    <p><strong>Selected Source:</strong></p>
                    <ul>
                        <li>Quality: ${data.selected_source.quality > 0 ? data.selected_source.quality + 'p' : 'Unknown'}</li>
                        <li>Format: ${data.selected_source.format}</li>
                        <li>Method: ${data.selected_source.method}</li>
                    </ul>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <p id="statusMessage">Initializing download...</p>
                </div>
            `;
        }

        function updateDownloadStatus(status) {
            const progressFill = document.getElementById('progressFill');
            const statusMessage = document.getElementById('statusMessage');
            
            if (progressFill) {
                progressFill.style.width = (status.progress || 0) + '%';
                
                // Update progress bar color based on status
                if (status.status === 'completed') {
                    progressFill.style.backgroundColor = '#4CAF50';
                } else if (status.status === 'failed' || status.status === 'error') {
                    progressFill.style.backgroundColor = '#f44336';
                } else if (status.status === 'cancelled') {
                    progressFill.style.backgroundColor = '#ff9800';
                } else {
                    progressFill.style.backgroundColor = '#2196F3';
                }
            }
            
            if (statusMessage) {
                let message = status.message || 'Processing...';
                
                if (status.status === 'downloading' && status.downloaded && status.total_size) {
                    const downloadedMB = (status.downloaded / (1024*1024)).toFixed(2);
                    const totalMB = (status.total_size / (1024*1024)).toFixed(2);
                    message += ` (${downloadedMB}/${totalMB} MB)`;
                }
                
                if (status.status === 'completed' && (status.file_ready || status.file_size)) {
                    const fileSize = status.file_size ? (status.file_size / (1024*1024)).toFixed(2) : 'Unknown';
                    statusMessage.innerHTML = `
                        ${message}<br>
                        <a href="/download/${downloadId}" class="download-link" download>
                            üì• Download File (${fileSize} MB)
                        </a>
                    `;
                } else if (status.status === 'failed' || status.status === 'error') {
                    statusMessage.innerHTML = `
                        <span style="color: #f44336;">‚ùå ${message}</span>
                        ${status.error ? `<br><small>Error: ${status.error}</small>` : ''}
                    `;
                } else if (status.status === 'cancelled') {
                    statusMessage.innerHTML = `<span style="color: #ff9800;">‚ö†Ô∏è ${message}</span>`;
                } else {
                    statusMessage.textContent = message;
                }
            }
        }

        function displayError(error) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<h3>‚ùå Error:</h3><p>${error}</p>`;
            resultsDiv.className = 'results error';
        }

        // Example URLs for testing
        document.addEventListener('DOMContentLoaded', function() {
            const urlInput = document.getElementById('videoUrl');
            urlInput.placeholder = 'https://roa.ibomma.foo/d/Paradha-2025-NeKq-telugu-movie-watch-online.html';
        });
    </script>
</body>
</html>